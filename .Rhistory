params$gasoline
params$excise_gasoline
params$excise_diesel
params <- scenario_params(scenario_2,2030)
params$excise_diesel
params$excise_gasoline
fuel_price_fun1("gasoline",scenario_1,2030)
fuel_price_fun1("diesel",scenario_1,2030)
fuel_price_fun1("diesel",scenario_2,2030)
fuel_price_fun1("gasoline",scenario_2,2030)
params <- scenario_params(scenario_2,2030)
params$diesel
params$gasoline
fuel_price_fun1 <- function(type="diesel", sD, yeartime){
crudeoilprice <- oil_price_fun(sD,yeartime)
crackspread <- crackspread_fun(type=type,sD,yeartime)
margin <- 0.12
carbon_tax <- carbon_tax_fun(sD,yeartime)
excise_duty <-
NORA <- 0.02
bio <-  0.014
VAT <- 0.23
if(type=="diesel")
return(((crudeoilprice+crackspread)/159+margin + diesel_excise_duty_fun(sD,yeartime) + carbon_tax/1000*2.640 + NORA)*(1+VAT))
if(type=="gasoline")
return(((crudeoilprice+crackspread)/159+margin + gasoline_excise_duty_fun(sD,yeartime) + carbon_tax/1000*2.392 + NORA)*(1+VAT))
}
fuel_price_fun1("gasoline",scenario_2,2030)
params <- scenario_params(scenario_2,2030)
params$diesel
params <- scenario_params(scenario_2,2030)
fuel_price_fun1("diesel",scenario_2,2030)
fuel_price_fun1("gasoline",scenario_2,2030)
params$gasoline
fuel_price_fun1("gasoline",scenario_3,2030)
fuel_price_fun1("gasoline",scenario_3,2030)
fuel_price_fun1("diesel",scenario_3,2030)
fuel_price_fun1("gasoline",scenario_3,2030)
fuel_price_fun1("diesel",scenario_3,2030)
document()
rm(list = c("fuel_price_fun1"))
document()
check()
install()
fleet <- readxl::read_xlsx("~/Policy/AgentBasedModels/PHEVs/survey_fleet.xlsx",sheet=6, range="A1:P347")
bevs <- filter(fleet,type=="bev")
fleet <- fleet %>% filter(!is.na(`2021_rrp`))
library(tidyverse)
fleet <- fleet %>% filter(!is.na(`2021_rrp`))
fleet$kWh <- as.numeric(fleet$kWh)
fleet <- fleet %>% mutate(kWh=ifelse(!is.na(kWh),kWh,0))
fleet <- fleet %>% mutate(model_start=replace(model_start,is.na(model_start),1990))
fleet <- fleet %>% mutate(model_end= replace(model_end,is.na(model_end),3000))
use_data(fleet,overwrite = T)
library(devtools)
use_data(fleet,overwrite = T)
document()
check()
install()
library(devtools)
load_all()
mileage_vals
fuelcosts
abm
abm <- readRDS("~/Policy/AgentBasedModels/PHEVs/bev_grant_runs/scenario_A/abm_scenario_A_40runs_rnew_0.5.Rdata")
abm
abm[[1]]
fuel_price_fun1("diesel",abm[[2]],2023)
fuel_price_fun1("diesel",abm[[2]],2018)
fuel_price_fun1("diesel",abm[[2]],2019)
fuel_price_fun1("gasoline",abm[[2]],2019)
mileage_elastic <- function(epsilon,qev34,price){
return(mileage_vals[qev34]*(price/1.40)^epsilon)
}
mileage_elastic(-0.15,3,1.40)
mileage_elastic(-0.15,3,2.40)
abm[[1]]
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
library(tidyverse)
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab
library(lubridate)
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)))
date_tab
date_tab %>% tail()
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
date_tab
abm.e <- inner_join(abm[[1]],date_tab,by="t")
abm.e
abm.e <- inner_join(abm[[1]],date_tab,by="t")
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e <- abm.e %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
i <- 1
xi <- 1
abm.e <- abm.e %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm <- filter(abm, t < 101)
abm[[1]] <- filter(abm[[1]], t < 101)
mileage_elastic <- function(epsilon,qev34,price){
return(mileage_vals[qev34]*(price/1.40)^epsilon)
}
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t")
abm.e
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e %>% filter(type=="phev")
abm.e %>% filter(type=="phev") %>% dplyr::mutate(e=e_phev(WLTP,AER,mileage_vals[qev34],xi))
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e %>% filter(type=="phev") %>% dplyr::mutate(e=e_phev(WLTP,AER,mileage_vals[qev34],xi))
abm.e
abm.e %>% filter(type=="phev") %>% rowwise() %>% dplyr::mutate(e=e_phev(WLTP,AER,mileage_vals[qev34],xi))
dim(abm.e)
abm.e$t %>% range()
tail(abm.e)
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm[[1]] <- filter(abm[[1]], t < 10)
dim(abm[[1]])
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t")
dim(abm.e)
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm[[1]] <- filter(abm[[1]], t==100)
abm[[1]]
abm <- readRDS("~/Policy/AgentBasedModels/PHEVs/bev_grant_runs/scenario_A/abm_scenario_A_40runs_rnew_0.5.Rdata")
abm[[1]] <- filter(abm[[1]], t==100)
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t")
dim(abm.e)
36960/924
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e[1:20,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e
abm.e$e
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e
abm.e
abm.e
abm <- readRDS("~/Policy/AgentBasedModels/PHEVs/bev_grant_runs/scenario_A/abm_scenario_A_40runs_rnew_0.5.Rdata")
abm[[1]]
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,qev34,diesel,gasoline,WLTP)
abm.e
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,qev34,diesel,gasoline,WLTP)
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
date_tab
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
abm.e
#real-world emissions
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
filter(abm.e,type=="phev")[1:10,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
mileage_vals
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e
filter(abm.e,type=="phev")[1:10,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
filter(abm.e,type=="phev")[1:10,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi))) %>% arange(simulation,date)
filter(abm.e,type=="phev")[1:10,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi))) %>% arrange(simulation,date)
filter(abm.e,type=="phev")[1:10,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],0.5))) %>% arrange(simulation,date)
filter(abm.e,type=="phev")[1:10,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],1))) %>% arrange(simulation,date)
filter(abm.e,type=="phev")[1:10,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],1))) %>% arrange(simulation,date) %>% system.time()
filter(abm.e,type=="phev")[1:100,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],1))) %>% arrange(simulation,date) %>% system.time()
filter(abm.e,type=="phev")[1:1000,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],1))) %>% arrange(simulation,date) %>% system.time()
filter(abm.e,type=="phev")[1:10000,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],1))) %>% arrange(simulation,date) %>% system.time()
dim(abm.e)[1]/10000*11
dim(abm.e)[1]/10000*11/60
filter(abm.e,type=="phev")[1:10000,] %>% rowwise() %>% dplyr::mutate(e=e_phev(WLTP,AER,mileage_vals[qev34],1))) %>% arrange(simulation,date) %>% system.time()
filter(abm.e,type=="phev")[1:10000,] %>% rowwise() %>% dplyr::mutate(e=e_phev(WLTP,AER,mileage_vals[qev34],1)) %>% arrange(simulation,date) %>% system.time()
e_phev
uf_phev
uf_model_wide
c <- uf_model_wide %>% dplyr::filter(xi==1,mileage==15000)
c
c
c <- c[,3:13] %>% as.numeric()
c
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e))
mileage_elastic <- function(epsilon,qev34,price){
return(mileage_vals[qev34]*(price/1.40)^epsilon)
}
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
abm.e
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",1))
abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",1)) %>% system.time()
filter(abm.e, type=="phev")$e
filter(abm.e, type=="phev")$e
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
dim(abm.e)
replicate(e_phev(100,50,15000,1),10)
replicate(e_phev(100,50,15000,1),5)
replicate(5,e_phev(100,50,15000,1))
replicate(5,e_phev(100,50,15000,1)) %>% system.time()
replicate(1000,e_phev(100,50,15000,1)) %>% system.time()
dim(abm.e)
dim(abm.e %>% filter(type=="phev"))
replicate(215899,e_phev(100,50,15000,1)) %>% system.time()
replicate(10000,e_phev(100,50,15000,1)) %>% system.time()
e_phev <- Vectorize(e_phev)
mapply(e_phev, abm.e[1:10,"WLTP"],abm.e[1:10,"AER"],mileage_vals[abm.e[1:10,"qev34"]],1)
abm.e <- abm.e %>% mutate(mileage=mileage_vals[qev34])
mapply(e_phev, abm.e[1:10,"WLTP"],abm.e[1:10,"AER"],abm.e[1:10,"mileage"],1)
mapply(filter(e_phev,type=="phev", abm.e[1:10,"WLTP"],abm.e[1:10,"AER"],abm.e[1:1000,"mileage"],1))
mapply(filter(e_phev,type=="phev"), abm.e[1:10,"WLTP"],abm.e[1:10,"AER"],abm.e[1:1000,"mileage"],1)
mapply(e_phev, abm.e[1:1000,"WLTP"],abm.e[1:1000,"AER"],abm.e[1:100000,"mileage"],1)
mapply(e_phev, abm.e[1:1000,"WLTP"],abm.e[1:1000,"AER"],abm.e[1:1000,"mileage"],1)
abm.p <- filter(abm.e,type=="phev")
mapply(e_phev, abm.p[1:1000,"WLTP"],abm.p[1:1000,"AER"],abm.p[1:1000,"mileage"],1)
mapply(e_phev, abm.p[1:1000,"WLTP"],abm.p[1:1000,"AER"],abm.p[1:1000,"mileage"],1) %>% system.time()
mapply(e_phev, abm.p[1:10000,"WLTP"],abm.p[1:10000,"AER"],abm.p[1:10000,"mileage"],1) %>% system.time()
abm.p[1:1000,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi))) %>% system.time()
abm.p[1:10000,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi))) %>% system.time()
abm.p[1:10000,] %>% rowwise() %>% dplyr::mutate(e=e_phev(WLTP,AER,mileage_vals[qev34],xi)) %>% system.time()
abm.e[1:1000,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi))) %>% system.time()
abm.e[1:10000,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi))) %>% system.time()
abm.e[1:10000,] %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",100)) %>% system.time()
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.p <- abm.e %>% filter(type=="phev") %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- bind_rows(filter(abm.e, type != "phev"),abm.p) %>% arrange(simulation,date,ID)
abm.e
addvars <- NULL
#abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e %>% group_by_at(c("t","simulation",addvars)) %>% dplyr::summarise(WLTP_mean=mean(WLTP) ,e_real=mean(e), tCO2=sum(e*mileage_vals[qev34])/1e+6/12)
#abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e %>% group_by_at(c("date","simulation",addvars)) %>% dplyr::summarise(WLTP_mean=mean(WLTP) ,e_real=mean(e), tCO2=sum(e*mileage_vals[qev34])/1e+6/12)
abm.e
dim(abm.e)
abm.e <- distinct(abm.e)
dim(abm.e)
abm.e <- abm.e %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
abm.e
abm.e <- abm.e %>% ungroup() %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
getEmissions <- function(abm, addvars=NULL, xi=1,epsilon = -0.15, average_over_runs=F,emissions_start_date=NULL){
#returns the EV adoption rate across runs
mileage_elastic <- function(epsilon,qev34,price){
return(mileage_vals[qev34]*(price/1.40)^epsilon)
}
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% dplyr::mutate(e=WLTP) #add adustment?
abm.p <- abm.e %>% filter(type=="phev") %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- bind_rows(filter(abm.e, type != "phev"),abm.p) %>% arrange(simulation,date,ID)
#abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e %>% group_by_at(c("date","simulation",addvars)) %>% dplyr::summarise(WLTP_mean=mean(WLTP) ,e_real=mean(e), tCO2=sum(e*mileage_vals[qev34])/1e+6/12)
abm.e <- distinct(abm.e)
#abm.e <- inner_join(abm.e,date_tab,by="") %>% ungroup() %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
abm.e <- abm.e %>% ungroup() %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
#average over runs
if(average_over_runs){
abm.e <- abm.e %>% group_by_at(c("date",addvars)) %>% summarise(e_real=mean(e_real),tCO2=mean(tCO2))
abm.e <- abm.e %>% group_by_at(addvars) %>% mutate(cumulative_tCO2=cumsum(tCO2))
if(!is.null(emissions_start_date)){
abm0 <- filter(abm.e, date==emissions_start_date) %>% select(type,cumulative_tCO2)
names(abm0)[2] <- "offset"
abm.e <- inner_join(abm.e,abm0,by="type")
abm.e <- abm.e %>% filter(date >= emissions_start_date) %>% group_by_at(addvars) %>% mutate(cumulative_tCO2=cumulative_tCO2-offset)
abm.e <- abm.e %>% select(-offset)
}
}
return(abm.e)
}
getEmissions(abm)
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% mutate(mileage=mileage_vals[qev34])
abm.e
abm.e <- abm.e %>% mutate(mileage=replace(mileage,type %in% c("diesel"),mileage_elastic(epsilon,qev34,diesel) ))
epsilon <- -0.15
abm.e <- abm.e %>% mutate(mileage=replace(mileage,type %in% c("diesel"),mileage_elastic(epsilon,qev34,diesel) ))
abm.e <- abm.e %>% rowwise() %>% mutate(mileage=replace(mileage,type %in% c("diesel"),mileage_elastic(epsilon,qev34,diesel) ))
abm.e
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% mutate(mileage=mileage_vals[qev34])
getEmissions <- function(abm, addvars=NULL, xi=1,epsilon = -0.15, average_over_runs=F,emissions_start_date=NULL){
#returns the EV adoption rate across runs
mileage_elastic <- function(epsilon,qev34,price){
return(mileage_vals[qev34]*(price/1.40)^epsilon)
}
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% mutate(mileage=mileage_vals[qev34])
abm.e <- abm.e %>% dplyr::mutate(e=WLTP)  #add adustment?
if(epsilon != 0){
abm.e <- abm.e %>% rowwise() %>% mutate(mileage=replace(mileage,type %in% c("diesel"),mileage_elastic(epsilon,qev34,diesel) ))
abm.e <- abm.e %>% rowwise() %>% mutate(mileage=replace(mileage,type %in% c("gasoline","hev"),mileage_elastic(epsilon,qev34,gasoline) ))
}
abm.p <- abm.e %>% filter(type=="phev") %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage,xi)))
abm.e <- bind_rows(filter(abm.e, type != "phev"),abm.p) %>% arrange(simulation,date,ID)
#abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e %>% group_by_at(c("date","simulation",addvars)) %>% dplyr::summarise(WLTP_mean=mean(WLTP) ,e_real=mean(e), tCO2=sum(e*mileage)/1e+6/12)
abm.e <- distinct(abm.e)
#abm.e <- inner_join(abm.e,date_tab,by="") %>% ungroup() %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
abm.e <- abm.e %>% ungroup() %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
#average over runs
if(average_over_runs){
abm.e <- abm.e %>% group_by_at(c("date",addvars)) %>% summarise(e_real=mean(e_real),tCO2=mean(tCO2))
abm.e <- abm.e %>% group_by_at(addvars) %>% mutate(cumulative_tCO2=cumsum(tCO2))
if(!is.null(emissions_start_date)){
abm0 <- filter(abm.e, date==emissions_start_date) %>% select(type,cumulative_tCO2)
names(abm0)[2] <- "offset"
abm.e <- inner_join(abm.e,abm0,by="type")
abm.e <- abm.e %>% filter(date >= emissions_start_date) %>% group_by_at(addvars) %>% mutate(cumulative_tCO2=cumulative_tCO2-offset)
abm.e <- abm.e %>% select(-offset)
}
}
return(abm.e)
}
getEmissions(abm) %>% filter(date=="2030-12-01") %>% summarise(tCO2=mean(tCO2))
emit <- getEmissions(abm)
emit
mileage_elastic <- function(epsilon,qev34,price){
return(mileage_vals[qev34]*(price/1.40)^epsilon)
}
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% mutate(mileage=mileage_vals[qev34])
abm.e <- abm.e %>% dplyr::mutate(e=WLTP)  #add adustment?
if(epsilon != 0){
abm.e <- abm.e %>% rowwise() %>% mutate(mileage=replace(mileage,type %in% c("diesel"),mileage_elastic(epsilon,qev34,diesel) ))
abm.e <- abm.e %>% rowwise() %>% mutate(mileage=replace(mileage,type %in% c("gasoline","hev"),mileage_elastic(epsilon,qev34,gasoline) ))
}
abm.e <- bind_rows(filter(abm.e, type != "phev"),abm.p) %>% arrange(simulation,date,ID)
abm.e
mileage_elastic(-0.15,1,1.4)
mileage_elastic(-0.15,1,1.5)
mileage_elastic(-0.15,1,1.21)
emit
abm.e
#abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e %>% group_by_at(c("date","simulation",addvars)) %>% dplyr::summarise(WLTP_mean=mean(WLTP) ,e_real=mean(e), tCO2=sum(e*mileage)/1e+6/12)
abm.e
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% mutate(mileage=mileage_vals[qev34])
abm.e <- abm.e %>% dplyr::mutate(e=WLTP)  #add adustment?
if(epsilon != 0){
abm.e <- abm.e %>% dplyr::rowwise() %>% mutate(mileage=replace(mileage,type %in% c("diesel"),mileage_elastic(epsilon,qev34,diesel) ))
abm.e <- abm.e %>% dplyr::rowwise() %>% mutate(mileage=replace(mileage,type %in% c("gasoline","hev"),mileage_elastic(epsilon,qev34,gasoline) ))
}
abm.e <- bind_rows(filter(abm.e, type != "phev"),abm.p) %>% arrange(simulation,date,ID)
#abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e %>% group_by_at(c("date","simulation",addvars)) %>% dplyr::summarise(WLTP_mean=mean(WLTP) ,e_real=mean(e), tCO2=sum(e*mileage)/1e+6/924)
#abm.e <- inner_join(abm.e,date_tab,by="") %>% ungroup() %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
abm.e <- abm.e %>% ungroup() %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
abm.e
getEmissions(abm,epsilon = 0) %>% filter(date=="2030-12-01") %>% summarise(tCO2=mean(tCO2))
getEmissions(abm,epsilon = -0.15) %>% filter(date=="2030-12-01") %>% summarise(tCO2=mean(tCO2))
getEmissions <- function(abm, addvars=NULL, xi=1,epsilon = 0, average_over_runs=F,emissions_start_date=NULL){
#returns the EV adoption rate across runs
mileage_elastic <- function(epsilon,qev34,price){
return(mileage_vals[qev34]*(price/1.40)^epsilon)
}
year_zero <- 2015
y_zero <- lubridate::ymd(paste(year_zero,1,1))
end_year <-  filter(abm[["system"]],parameter=="end_year")$value
Nt <- (end_year+1-year_zero)*12
date_tab <- tibble(t=1:Nt)
date_tab <- date_tab %>% mutate(date=y_zero+months(t-1))
date_tab <- date_tab %>% mutate(diesel=fuel_price_fun1("diesel",abm[[2]],decimal_date(date)),gasoline=fuel_price_fun1("gasoline",abm[[2]],decimal_date(date)))
abm.e <- inner_join(abm[[1]],date_tab,by="t") %>% dplyr::select(ID,date,simulation,type,AER,qev34,diesel,gasoline,WLTP)
#real-world emissions
abm.e <- abm.e %>% arrange(simulation,date,ID)
abm.e <- abm.e %>% mutate(mileage=mileage_vals[qev34])
abm.e <- abm.e %>% dplyr::mutate(e=WLTP)  #add adustment?
if(epsilon != 0){
abm.e <- abm.e %>% dplyr::rowwise() %>% mutate(mileage=replace(mileage,type %in% c("diesel"),mileage_elastic(epsilon,qev34,diesel) ))
abm.e <- abm.e %>% dplyr::rowwise() %>% mutate(mileage=replace(mileage,type %in% c("gasoline","hev"),mileage_elastic(epsilon,qev34,gasoline) ))
}
abm.p <- abm.e %>% filter(type=="phev") %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage,xi)))
abm.e <- bind_rows(filter(abm.e, type != "phev"),abm.p) %>% arrange(simulation,date,ID)
#abm.e <- abm.e %>% rowwise() %>% dplyr::mutate(e=replace(e,type=="phev",e_phev(WLTP,AER,mileage_vals[qev34],xi)))
abm.e <- abm.e %>% group_by_at(c("date","simulation",addvars)) %>% dplyr::summarise(WLTP_mean=mean(WLTP) ,e_real=mean(e), tCO2=sum(e*mileage)/1e+6/924)
abm.e <- distinct(abm.e)
#abm.e <- inner_join(abm.e,date_tab,by="") %>% ungroup() %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
abm.e <- abm.e %>% ungroup() %>% select("simulation","date",addvars,"WLTP_mean","e_real","tCO2")
#average over runs
if(average_over_runs){
abm.e <- abm.e %>% group_by_at(c("date",addvars)) %>% summarise(e_real=mean(e_real),tCO2=mean(tCO2))
abm.e <- abm.e %>% group_by_at(addvars) %>% mutate(cumulative_tCO2=cumsum(tCO2))
if(!is.null(emissions_start_date)){
abm0 <- filter(abm.e, date==emissions_start_date) %>% select(type,cumulative_tCO2)
names(abm0)[2] <- "offset"
abm.e <- inner_join(abm.e,abm0,by="type")
abm.e <- abm.e %>% filter(date >= emissions_start_date) %>% group_by_at(addvars) %>% mutate(cumulative_tCO2=cumulative_tCO2-offset)
abm.e <- abm.e %>% select(-offset)
}
}
return(abm.e)
}
getEmissions(abm,epsilon = -0.15) %>% filter(date=="2030-12-01") %>% summarise(tCO2=mean(tCO2))
getEmissions(abm,epsilon = 0) %>% filter(date=="2030-12-01") %>% summarise(tCO2=mean(tCO2))
document()
rm(list = c("e_phev", "end_year", "getEmissions", "year_zero"))
document()
check()
install()
ls()
rm(abm)
rm(abm.e)
am(abm.p)
rm(abm.p)
ls()
rm(i)
rm(list = ls())
ls()
usethis::use_pipe()
document()
use_mit_license()
